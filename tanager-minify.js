function countKeyStrokes(){keyCounter++}var keyCounter=0,autoSaveInterval=3e5,intervalID=0,prevLength=0,currLength=0,isFocus=0,$=document;$.addEventListener("DOMContentLoaded",function(){function e(){y($.getElementById("text_preview")),d($.getElementById("tx_input")),$.getElementById("col_left").className="singlecol",$.getElementById("col_right").className="col",$.getElementById("col_right").style.cssFloat="right",$.getElementById("col_right").style.position="relative",$.getElementById("tx_input").focus()}function t(){d($.getElementById("tx_input")),d($.getElementById("text_preview")),$.getElementById("col_left").className="col",$.getElementById("col_right").className="col",$.getElementById("col_right").style.cssFloat="right",$.getElementById("col_right").style.position="relative",$.getElementById("tx_input").focus()}function n(){var e=$.getElementById("col_left").className;"singlecol"===e&&($.getElementById("col_left").className="col",y($.getElementById("tx_input")),$.getElementById("col_right").className="prevsinglecol",$.getElementById("col_right").style.cssFloat="normal",$.getElementById("col_right").style.position="absolute",d($.getElementById("text_preview")));var t,n=$.getElementById("tx_input").value,l=/^autosave=(\d+)$/m;(t=l.exec(n))&&t[1]>0&&1e3*t[1]!=autoSaveInterval&&(autoSaveInterval=1e3*t[1],clearInterval(intervalID),intervalID=setInterval(function(){o()},autoSaveInterval));var r="Preview";c(n,r)}function l(){keyCounter++,o()}function o(){var e=$.getElementById("tx_input").value;if(currLength=e.length,0!=keyCounter||currLength!=prevLength){prevLength=currLength,keyCounter=0;var t=($.getElementById("col_left").className,"Create");"updateblog"===action&&(t="Update"),c(e,t)}}function r(){var e={action:$.getElementById("tanageraction").value,cgiapp:$.getElementById("tanagercgiapp").value,apiurl:$.getElementById("tanagerapiurl").value,postrev:$.getElementById("tanagerpostrev").value,postid:$.getElementById("tanagerpostid").value};return e}function a(e){var t=$.cookie,n=t.indexOf(" "+e+"=");if(-1==n&&(n=t.indexOf(e+"=")),-1==n)t=null;else{n=t.indexOf("=",n)+1;var l=t.indexOf(";",n);-1==l&&(l=t.length),t=unescape(t.substring(n,l))}return t}function i(){var e=$.getElementById("col_left"),t=$.getElementById("tx_input"),n=null,l=e.children;[].forEach.call(l,function(e){n+=s(e)});var o=e.offsetHeight-(n-s(t));$.getElementById("tx_input").style.height=o+"px",$.getElementById("text_preview").style.height=o+"px"}function s(e){var t=e.offsetHeight,n=getComputedStyle(e);return t+=parseInt(n.marginTop)+parseInt(n.marginBottom)}function y(e){e.style.opacity=1,function t(){(e.style.opacity-=.1)<0?e.style.display="none":requestAnimationFrame(t)}()}function d(e,t){e.style.opacity=0,e.style.display=t||"block",function n(){var t=parseFloat(e.style.opacity);(t+=.1)>1||(e.style.opacity=t,requestAnimationFrame(n))}()}function c(e,t){var n=r(),l=n.action,o=(n.cgiapp,n.apiurl),i=(n.postrev,n.postid);e=escape(e);var s={author:a("wrenauthor_name"),session_id:a("wrensession_id"),rev:a("wrenrev"),submit_type:t,form_type:"ajax",markup:e,original_slug:i},y=JSON.stringify(s),d=new XMLHttpRequest;"updateblog"===l?d.open("PUT",o+"/posts",!0):d.open("POST",o+"/posts",!0),d.withCredentials=!0,d.setRequestHeader("Content-Type","application/json; charset=UTF-8"),d.onload=function(){if(d.status>=200&&d.status<400){var e=d.responseText,n=JSON.parse(e);"article"==n.post_type?$.getElementById("text_preview").innerHTML="<h1>"+n.title+"</h1>"+n.html:$.getElementById("text_preview").innerHTML=n.html,("Create"===t||"Update"===t)&&($.getElementById("saveposttext").style.color="#000",setTimeout(function(){$.getElementById("saveposttext").style.color="#f8f8f8"},2e3),$.getElementById("tanageraction").value="updateblog",$.getElementById("tanagerpostid").value=n.slug,$.getElementById("tanagerpostrev").value=n.rev)}else{var e=d.responseText,n=JSON.parse(e);$.getElementById("text_preview").innerHTML="<h1>Error</h1>"+n.user_message+" "+n.system_message}},d.onerror=function(){$.getElementById("text_preview").innerHTML="<h1>Server Connection Error</h1> Unable to connect to "+o+"/posts"},d.send(y)}window.onresize=i;var g=window.onresize;g(),onkeydown=function(l){l.ctrlKey&&l.keyCode=="P".charCodeAt(0)&&(l.preventDefault(),n()),l.ctrlKey&&l.keyCode=="S".charCodeAt(0)&&(l.preventDefault(),keyCounter++,o()),l.ctrlKey&&l.keyCode=="U".charCodeAt(0)&&(l.preventDefault(),e()),l.ctrlKey&&l.keyCode=="J".charCodeAt(0)&&(l.preventDefault(),$.body.style.background="#fff",$.getElementById("navmenu").style.display="none",$.getElementById("tx_input").style.background="#fff",$.getElementById("tx_input").style.border="none",$.getElementById("tx_input").style.color="#222",$.getElementById("col_left").style.padding="1em 0 0 0",e()),l.ctrlKey&&l.keyCode=="H".charCodeAt(0)&&(l.preventDefault(),$.body.style.background="#fff",$.getElementById("navmenu").style.display="none",$.getElementById("tx_input").style.background="#fff",$.getElementById("tx_input").style.border="none",$.getElementById("tx_input").style.color="#222",$.getElementById("tx_input").style.height="150px",$.getElementById("tx_input").style.margin="30% 0 0 0",$.getElementById("col_left").style.padding="1em 0 0 0",isFocus=1,e()),l.ctrlKey&&l.keyCode=="B".charCodeAt(0)&&(l.preventDefault(),$.body.style.background="#ddd",$.getElementById("navmenu").style.display="inline",$.getElementById("tx_input").style.background="#f8f8f8",$.getElementById("tx_input").style.border="1px solid #bbb",$.getElementById("tx_input").style.color="#222",$.getElementById("col_left").style.padding="0",isFocus&&($.getElementById("tx_input").style.margin="0 0 0 0",$.getElementById("tx_input").style.height="100%",ifFocus=0),t()),l.ctrlKey&&l.keyCode=="D".charCodeAt(0)&&(l.preventDefault(),$.body.style.background="#181818",$.getElementById("tx_input").style.background="#181818",$.getElementById("tx_input").style.color="#c0c0c0")},intervalID=setInterval(function(){o()},autoSaveInterval),$.getElementById("moveButton").onclick=e,$.getElementById("resetButton").onclick=t,$.getElementById("previewButton").onclick=n,$.getElementById("saveButton").onclick=l});
